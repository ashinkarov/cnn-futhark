\documentclass[acmsmall,screen,anonymous,review]{acmart}
\usepackage{listings}
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\usepackage{microtype}
\usepackage{mathtools} % needed for \doublecolon symbol
\usepackage{bbold} % For extended blackboard bold symbols
\usepackage{fancyvrb}

\usepackage{todonotes}

% Add definitions for abbreviations like e.g.; i.e; etc. with
% correct spacing depending on the parameters.  In this case
% `all' exposes all the definitions of the package, and `british'
% makes sure that there is no comma after e.g. or i.e.
\usepackage[all,british]{foreign}

\lstdefinelanguage{SaC}[]{}{%
    language=C,
    morekeywords={inline,return,for,shape,dim,with,fold,modarray,genarray},
    otherkeywords={?,:,->},
    comment=[l][\color{green!50!brown}]{//},
    morecomment=[s][\color{blue!70!gray}]{int[}{]},
    morecomment=[s][\color{blue!70!gray}]{double[}{]}
}
\lstset{%
    basicstyle=\fontsize{8}{8}\selectfont\ttfamily,
    language=SaC,
    keywordstyle=\color{blue!70!gray},
    commentstyle=\color{green!50!brown},
    stringstyle=\color{violet!40!magenta},
    %showstringspaces=false,
}

% https://tex.stackexchange.com/questions/318142/typeseeting-a-multiset-with-double-curly-braces
\newcommand*{\xlbrace}{[\mskip-5mu[}
\newcommand*{\xrbrace}{]\mskip-5mu]}

\newcommand*{\ldblbrace}{\{\mskip-5mu\{}
\newcommand*{\rdblbrace}{\}\mskip-5mu\}}


\usepackage{bm}
\usepackage{agda}
\usepackage{newunicodechar}

\usepackage{mathpartir}
\usepackage{varwidth}
% Do we need this?
\usepackage{microtype} 

\newcommand\codeblock[1]{%
  %{\fbox{\begin{varwidth}{0.9\textwidth}#1\end{varwidth}}}
  {\begin{varwidth}{0.9\textwidth}#1\end{varwidth}}
} 


\newunicodechar{‚ÇÄ}{\ensuremath{_0}}
\newunicodechar{‚ÇÅ}{\ensuremath{_1}}
\newunicodechar{‚ÇÇ}{\ensuremath{_2}}
\newunicodechar{‚ÇÉ}{\ensuremath{_3}}
\newunicodechar{‚ÇÑ}{\ensuremath{_4}}
\newunicodechar{‚ÇÖ}{\ensuremath{_5}}
\newunicodechar{‚ÇÜ}{\ensuremath{_6}}
\newunicodechar{‚Çá}{\ensuremath{_7}}
\newunicodechar{‚Çà}{\ensuremath{_8}}
\newunicodechar{‚Çâ}{\ensuremath{_9}}
\newunicodechar{Œπ}{\ensuremath{\iota}}
\newunicodechar{‚Çó}{\ensuremath{_l}}
\newunicodechar{‚Çê}{\ensuremath{_a}}
\newunicodechar{‚Çñ}{\ensuremath{_k}}
\newunicodechar{·µ¢}{\ensuremath{_i}}
\newunicodechar{‚±º}{\ensuremath{_j}}
\newunicodechar{·µ•}{\ensuremath{_v}}
\newunicodechar{‚Çï}{\ensuremath{_h}}
\newunicodechar{‚Çö}{\ensuremath{_p}}
\newunicodechar{‚Çõ}{\ensuremath{_s}}
\newunicodechar{‚Çí}{\ensuremath{_o}}
\newunicodechar{‚Çô}{\ensuremath{_n}}


\newunicodechar{·µ£}{\ensuremath{_r}}
\newunicodechar{ ≥}{\ensuremath{^r}}
\newunicodechar{À°}{\ensuremath{^l}}
\newunicodechar{·µõ}{\ensuremath{^v}}
\newunicodechar{·µâ}{\ensuremath{^e}}
\newunicodechar{‚Ñï}{\ensuremath{\mathbb{N}}}
\newunicodechar{‚Ñù}{\ensuremath{\mathbb{R}}}
\newunicodechar{ùüò}{\ensuremath{\mathbb{0}}}

\newunicodechar{‚àÄ}{\ensuremath{\forall}}
\newunicodechar{‚àÉ}{\ensuremath{\exists}}
\newunicodechar{‚â°}{\ensuremath{\equiv}}
\newunicodechar{‚âà}{\ensuremath{\approx}}
\newunicodechar{‚âü}{\ensuremath{\stackrel{?}{=}}}
\newunicodechar{‚àé}{\ensuremath{\blacksquare}}
\newunicodechar{‚äõ}{\ensuremath{\circledast}}
\newunicodechar{‚äó}{\ensuremath{\otimes}}
\newunicodechar{‚äï}{\ensuremath{\oplus}}
\newunicodechar{‚äù}{\ensuremath{\ominus}}
\newunicodechar{‚â§}{\ensuremath{\le}}
\newunicodechar{œÜ}{\ensuremath{\phi}}
\newunicodechar{œà}{\ensuremath{\psi}}
\newunicodechar{Œµ}{\ensuremath{\epsilon}}
\newunicodechar{Œ¥}{\ensuremath{\delta}}
\newunicodechar{Œª}{\ensuremath{\lambda}}
\newunicodechar{œÉ}{\ensuremath{\sigma}}
\newunicodechar{œÅ}{\ensuremath{\rho}}
\newunicodechar{ŒΩ}{\ensuremath{\nu}}
\newunicodechar{‚àÇ}{\ensuremath{\partial}}

\newunicodechar{Œì}{\ensuremath{\Gamma}}
\newunicodechar{Œî}{\ensuremath{\Delta}}
\newunicodechar{Œ®}{\ensuremath{\Phi}}
\newunicodechar{Œû}{\ensuremath{\Xi}}

\newunicodechar{‚Ä≤}{{'}}
\newunicodechar{‚à∑}{\ensuremath{\dblcolon}}
\newunicodechar{‚Üî}{\ensuremath{\leftrightarrow}}
\newunicodechar{‚Ü¶}{\ensuremath{\mapsto}}
\newunicodechar{‚àò}{\ensuremath{\circ}}
\newunicodechar{‚Åª}{\ensuremath{^{-}}}
\newunicodechar{‚àô}{\ensuremath{\boldsymbol{\cdot}}}
\newunicodechar{‚ñπ}{\ensuremath{\triangleright}}
\newunicodechar{‚ãØ}{\ensuremath{\cdots}}
\newunicodechar{‚àá}{\ensuremath{\nabla}}
\newunicodechar{Œ£}{\ensuremath{\Sigma}}
\newunicodechar{‚àà}{\ensuremath{\in}}
\newunicodechar{‚ü¶}{\ensuremath{\llbracket}}
\newunicodechar{‚üß}{\ensuremath{\rrbracket}}
\newunicodechar{‚¶É}{\ensuremath{\ldblbrace}}
\newunicodechar{‚¶Ñ}{\ensuremath{\rdblbrace}}
\newunicodechar{‚åä}{\ensuremath{\lfloor}}
\newunicodechar{‚åã}{\ensuremath{\rfloor}}
  

\newunicodechar{‚áí}{\ensuremath{\Rightarrow}}
\newunicodechar{‚ü™}{\ensuremath{\xlbrace}}
\newunicodechar{‚ü´}{\ensuremath{\xrbrace}}
\newunicodechar{‚ä†}{\ensuremath{\boxtimes}}
\newunicodechar{‚äû}{\ensuremath{\boxplus}}
\newunicodechar{‚àã}{\ensuremath{\ni}}
\newunicodechar{‚à∂}{\ensuremath{\bm{:}}}
\newunicodechar{‚Ü¶}{\ensuremath{\mapsto}}
\newunicodechar{‚ä§}{\ensuremath{\top}}
\newunicodechar{‚äÜ}{\ensuremath{\subseteq}}
\newunicodechar{‚äé}{\ensuremath{\uplus}}





% Some shortcut commands for agda symbols
\newcommand{\AD}[1]{\AgdaDatatype{#1}}
\newcommand{\AC}[1]{\AgdaInductiveConstructor{#1}}
\newcommand{\AF}[1]{\AgdaFunction{#1}}
\newcommand{\AB}[1]{\AgdaBound{#1}}
\newcommand{\AK}[1]{\AgdaKeyword{#1}}
\newcommand{\AR}[1]{\AgdaField{#1}}
\newcommand{\AM}[1]{\AgdaModule{#1}}
\newcommand{\AN}[1]{\AgdaNumber{#1}}
\newcommand{\AS}[1]{\AgdaString{#1}}

\renewcommand{\AgdaCommentFontStyle}[1]{\textrm{#1}}
\renewcommand{\AgdaFontStyle}[1]{\textrm{#1}}
\renewcommand{\AgdaKeywordFontStyle}[1]{\textrm{#1}}

\pgfplotstableset{col sep=comma}

\title{Correctness meets high performance in Agda}

\author{Artjoms {\v{S}}inkarovs}
\email{artjoms.sinkarovs@pm.me}
\orcid{0000-0003-3292-2985}
\affiliation{%
  \institution{University of Southampton}
  \streetaddress{University of Southampton, University Road}
  \city{Southampton}
  \country{UK}
  \postcode{SO17 1BJ}
}
\author{Troels Henriksen}
\email{athas@sigkill.dk}
\orcid{0000-0002-1195-9722}
\affiliation{%
  \institution{University of Copenhagen}
  \streetaddress{Universitetsparken 5}
  \city{Copenhagen}
  \country{Denmark}
  \postcode{2100}
}

%\renewcommand{\shortauthors}%
%  {A.~{\v{S}}inkarovs, T.~Koopman, and S.~Scholz}


\pgfkeys{/pgf/number format/.cd,fixed,precision=0}


\keywords{Dependent Types, Agda, Array Programming, Automatic Differentiation, SaC}

% TODO: Insert CCSXML and CCSdesc later.
%\begin{CCSXML}
%\end{CCSXML}
%
% \ccsdesc[500]{Theory of computation~Data structures design and analysis}
% \ccsdesc[500]{Theory of computation~Algorithm design techniques}
% \ccsdesc[500]{Software and its engineering~Source code generation}
% \ccsdesc[300]{Software and its engineering~Functional languages}
% \ccsdesc[500]{Software and its engineering~Data types and structures}


\begin{document}

\begin{abstract}
In this paper we demonstrate a technique for developing high performance applications
with strong correctness guarantees.  We use a theorem prover to derive a high-level
specification of the application that includes correctness invariants of our choice.
After that, within the same theorem prover, we implement an extraction of the
specified application into a high-performance language of our choice.  Concretely,
we are using Agda to specify a framework for automatic differentiation (reverse mode)
that is focused on index-safe tensors.  This framework comes
with an optimiser for tensor expressions and the ability to translate these
expressions into Futhark.  We specify a canonical convolutional neural network
within the proposed framework, compute the derivatives needed for the training
phase and then demonstrate that the generated code approaches the performance of TensorFlow
code when running on a GPU.
\end{abstract}

\maketitle

\input{intro}
\input{latex/arrays}
\input{latex/lang}
\input{latex/ad}
\input{performance}
\input{relatedwork}
\input{conclusions}

\bibliographystyle{ACM-Reference-Format}
\bibliography{paper}

\end{document}
