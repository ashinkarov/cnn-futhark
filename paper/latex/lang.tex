\begin{code}[hide]%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}%
\>[13]\AgdaPragma{--backtracking-instance-search}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\<%
\\
\>[0]\AgdaComment{--open\ import\ Function\ hiding\ (⟨\AgdaUnderscore{}⟩)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{--\ Our\ local\ files.}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{arrays}\<%
\\
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\section{Embedded DSL}

Any implementation of automatic differentiation has to decide which operations
are supported.  Surely, it does not make sense to compute derivatives
of a function that opens a file.  This choice, no matter how it is implemented,
can be seen as a definition of an embedded language.
Once we accept to identify an embedded language, the idea of embedding it in a way
that facilitates extraction actually appears rather naturally and thus advances
the approach that we propose in this paper.

Coming back to our example, we have to choose the primitives that the embedded language
should support. They need to be sufficient to express AD as well as to define CNNs.
The main trade-off here is the choice of the level of abstraction of these primitives:
low-level primitives are easier to differentiate, but they make the overall expressions
more complex which also adds to the challenge of optimising code.
Making this choice is difficult and, most likely, requires quite some adjustment 
when striving for performance.
Here we see a key benefit of the approach we propose in this paper:
the use of a single framework for the embedding, the optimisation, and the extraction
makes the implementation comparatively small, allowing for quick adjustments in the
level of abstraction, code optimisation and its extraction.
We start with a pragmatic approach; we include the primitives that are either shared
by the model and the back-end
or that can be easily implemented in the back-end language.

It turns out that it is possible to choose the primitives in a way that the derivatives 
can be expressed in the very same embedded language. 
While this at first glance may just seem to be just a nice coincidence, it turns out
that this has several tangible benefits: high-order derivatives can be computed 
by the same transformation and we can share all optimisations between the code itself
and its derivatives.
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Lang}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaComment{--open\ Array\ hiding\ (sum;\ slide;\ backslide)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{15}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}\<%
\\
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Ar}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{public}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{CNN}\AgdaSpace{}%
\AgdaKeyword{public}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Ar}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{slide}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{backslide}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{imapb}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{selb}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{logistic}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\end{code}

As we operate within a dependently-typed proof-assistant, we can easily make our
embedded language well-scoped and intrinsically typed (shaped in our case).  Our
context \AF{Ctx} is a snoc-list of shapes where each shape has a tag indicating whether
it is an index or an array.  We use de Bruijn variables given by the relation
\AF{\_∈\_} in the usual way.  We also define variables \AB{v₁}, \AB{v₂}, \etc{}
by iteratively applying \AC{vₛ} to \AC{v₀} (definition not shown).
\begin{mathpar}
\codeblock{\begin{code}%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ix}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\<%
\\
%
\>[4]\AgdaInductiveConstructor{ar}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ε}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\end{code}}
\and
\codeblock{\begin{code}[hide]%
%
\>[2]\AgdaKeyword{variable}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Ξ}\AgdaSpace{}%
\AgdaGeneralizable{Ψ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[4]\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSpace{}%
\AgdaGeneralizable{iq}\AgdaSpace{}%
\AgdaGeneralizable{ir}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{IS}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}∈\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{v₀}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{vₛ}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSymbol{)}\<%
\end{code}}
\end{mathpar}
Note that while our contexts are non-dependent (\ie{} the shapes do not depend on the
terms), we use non-trivial shape dependencies within the constructors.  The embedded
language does not have a notion of shape as a value, therefore all the shape dependencies
are handled by Agda, keeping our language simply typed (shaped).  This separation is
very helpful when it comes to writing embedded programs.% XXX: more explanation? 
\begin{code}[hide]%
%
\>[2]\AgdaComment{--pattern\ v₀\ =\ v₀}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₃}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₂}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₃}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₅}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₄}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₆}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₅}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₇}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₆}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₈}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₇}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaInductiveConstructor{v₉}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₈}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊞\AgdaUnderscore{}}}\<%
\\
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{15}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊠\AgdaUnderscore{}}}\<%
\end{code}
We start with two helper definitions: a singleton shape that we call \AF{unit}
and the type for binary operations that we support (for now only addition and
multiplication).
\begin{mathpar}
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{unit}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\<%
\\
%
\>[2]\AgdaFunction{unit}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Bop}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Bop}\<%
\end{code}}
\end{mathpar}

The embedded language \AF{E} includes: variables \AC{var}; constants 0 and 1 given
by \AC{zero} and \AC{one} correspondingly; three flavours of array constructor/eliminator
pairs given by \AC{imapₛ}/\AC{selₛ}, \AC{imap}/\AC{sel} and \AC{imapb}/\AC{selb};
summation \AC{sum}; conditional \AC{zero-but} where the predicate is fixed to equality
of two indices and the else branch is zero; \AC{slide} and \AC{backslide} exactly
as described before; and numerical operations.  The latter includes \AC{logistic},
plus and multiplication, division by a constant \AC{scaledown}, and unary \AC{minus}.
The definition of the embedded language \AF{E} follows.  We also introduce the
syntax for infix plus and multiplication denoted \AC{⊞} and \AC{⊠} correspondingly.
%\begin{mathpar}
%\codeblock{
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{var}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[4]\AgdaInductiveConstructor{zero}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{one}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{imaps}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaFunction{unit}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{sels}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaFunction{unit}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{imap}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[4]\AgdaInductiveConstructor{sel}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{imapb}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{*}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{q}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{q}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{selb}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{*}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{q}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{q}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{sum}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{zero-but}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{slide}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{+}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{suc}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{backslide}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{suc}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{+}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaInductiveConstructor{logistic}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{bin}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Bop}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{scaledown}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{minus}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{let′}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊠\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaKeyword{pattern}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊞\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\<%
\end{code}
%}
%\end{mathpar}

\subsection{Reals}
\todo[inline]{Explain that this is our module for abstract reals with
  operations and their properties and that we parametrise our
  evaluator witht this module.}

\begin{code}%
\>[0]\AgdaKeyword{record}\AgdaSpace{}%
\AgdaRecord{Real}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set₁}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{field}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaField{R}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[4]\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{R}\<%
\\
%
\>[4]\AgdaOperator{\AgdaField{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}*\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}÷\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{R}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{R}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{R}\<%
\\
%
\>[4]\AgdaOperator{\AgdaField{-\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{e\textasciicircum{}\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{R}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{R}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}+\AgdaUnderscore{}}}\<%
\\
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{15}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}*\AgdaUnderscore{}}}\<%
\\
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{15}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}÷\AgdaUnderscore{}}}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaFunction{logisticʳ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{R}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaField{R}\<%
\\
%
\>[2]\AgdaFunction{logisticʳ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaField{÷}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaField{+}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{e\textasciicircum{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{-}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))}\<%
\end{code}


\subsection{Evaluation}
\todo[inline]{The text in this section needs adjustment}
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Eval}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{real}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Real}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaComment{--open\ import\ Data.Float\ as\ F\ renaming\ (Float\ to\ ℝ)\ hiding\ (⌊\AgdaUnderscore{}⌋)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}×\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Fin}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\#\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary.Decidable}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Bool}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Real}\AgdaSpace{}%
\AgdaBound{real}\<%
\end{code}

We define the interpretation \AF{⟦\_⟧} for (\AF{E} \AB{Γ} \AB{is}) into the value
(\AF{Val} \AB{is}) in the environment (\AF{Env} \AB{Γ}).  The values are either
arrays or positions of the corresponding shape.  Environments for the given context
\AB{Γ} are tuples of values of the corresponding shapes.  The \AF{lookup} function
translates variables within the context into variables within the environment.
\begin{mathpar}
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{Val}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Val}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaField{R}\<%
\\
%
\>[2]\AgdaFunction{Val}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{P}\AgdaSpace{}%
\AgdaBound{s}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}%
\>[16]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{is}\AgdaSymbol{)}%
\>[16]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaFunction{Val}\AgdaSpace{}%
\AgdaBound{is}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Val}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}%
\>[17]\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[26]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}%
\>[17]\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[26]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\end{code}}
\end{mathpar}

In the definition of \AF{⟦\_⟧} we wrap the environment argument into double braces.
This is an Agda-specific syntax for instance arguments\footnote{%
  For more details on instance arguments see:
  \url{https://agda.readthedocs.io/en/v2.6.3/language/instance-arguments.html}}
which behave similarly to hidden arguments, but they have a more powerful resolution
algorithm.  As a result we can omit mentioning the environment in recursive calls
when it is passed unchanged.
\begin{code}%
%
\>[2]\AgdaOperator{\AgdaFunction{⟦\AgdaUnderscore{}⟧}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Val}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{K}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{one}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{K}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{K}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{unnest}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{nest}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.imapb}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{m}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.selb}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Ar.zipWith}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{K}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{if}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⌊}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≟ₚ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⌋}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{then}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{else}}\AgdaSpace{}%
\AgdaFunction{K}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.slide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{p}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.backslide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.map}\AgdaSpace{}%
\AgdaFunction{logisticʳ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.zipWith}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.zipWith}\AgdaSpace{}%
\AgdaOperator{\AgdaField{\AgdaUnderscore{}*\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.map}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{\AgdaUnderscore{}÷}}\AgdaSpace{}%
\AgdaField{fromℕ}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Ar.map}\AgdaSpace{}%
\AgdaOperator{\AgdaField{-\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}%
\>[24]\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[29]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟦}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟧}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\end{code}
With the above definition we can better explain the choices of language constructors.
The most important question to clarify is why do we have three array
constructors/eliminators.  As the only conceptual datatype of our language is
an array (of some shape), we do not have any direct way to talk about array elements.
Therefore, we model the type of array elements (scalars) as arrays of a singleton shape.
As can be seen, scalar selection \AC{selₛ} returns a singleton array
(application of \AF{K}) where all the element(s) are equal to the element we are
selecting.  The corresponding array constructor \AC{imapₛ} makes sure that if we
compute \AB{s} elements of the shape \AF{unit}, we produce an array of shape \AB{s}
(and not \AB{s} \AC{⊗} \AF{unit}).  This soves the problem of constructing arays
from scalars, but how do we construct an array of a product shape?  Given that we
have an expression in the context (\AB{Γ} \AC{▹} \AC{ix} \AB{s} \AC{▹} \AC{ix} \AB{p}),
we need to produce an array of \AB{s} \AC{⊗} \AB{p}.  There are several ways how to
solve this (\eg{} introducing nest/unnest or projections and pairing on indices),
but it is clear that we need something more than just an \AC{imapₛ}.
This is the reason to introduce \AC{imap}/\AC{sel} pair which operates on arrays
of product shapes.  As average pooling operates on blocked arrays, we need
a construction to express this in \AF{E}.  One could introduce explicit 
\AF{block}/\AF{unblock}, but we merge blocking/unlocking action with
imap/sel obtaining \AC{imapb}/\AC{selb}.  Our \AC{sum} constructor 
gets an argument in the extended context which is summation index, so 
conceptually we generate the values at every summation index before
summing these values together.  As a result, we only need
one instance of \AC{sum} which makes our expressions a little tidier.




\subsection{Weakening and Substitution}
\todo[inline]{Adjust the text}
As our language has explicit de Bruin variables (as opposed to HOAS~\cite{hoas} approaches),
we need the means to do weakening and substitution when we optimise expressions in \AF{E}.
Our language is intrinsically typed(shaped) which
makes the definition of both operations challenging.  However, this problem has
been well-understood, and we adopt the solution from~\cite{subst}.  We only show the
basic mechanisms of the definition, for full details refer to~\cite{subst}.

The key structure that gives rise to weakening and substitution is a function that
computes the context \AB{Γ} \emph{without} the variable \AB{v} 
(denoted \AB{Γ} \AF{/} \AB{v}).  Then we define the weakening for
variables (\AF{wkv}) and expressions (\AF{wk}) that take a variable or expression
in the context without the variable \AF{v} and return this variable or expression
in the context where \AB{v} is present.
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{WkSub}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\end{code}
\begin{mathpar}
\codeblock{\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}⊆\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ε}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[4]\AgdaInductiveConstructor{skip}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\end{code}}
\and
\codeblock{\begin{code}  %
%
\>[2]\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\end{code}}
\end{mathpar}

\todo[inline]{Expand this (or hide?)}
\begin{code}%
%
\>[2]\AgdaFunction{⊆-eq}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{⊆-eq}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[2]\AgdaFunction{⊆-eq}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaFunction{⊆-eq}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}↑}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}↑}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{skip}\AgdaSpace{}%
\AgdaFunction{⊆-eq}\AgdaSymbol{)}\<%
\end{code}


% We give ourselves a nicer syntax for common cases when expressions
% are lifted into the context with extra one or two variables:
% \begin{code}[hide]
%   infixr 18 ↑_
%   infixr 18 ↑↑_
% \end{code}
% \begin{mathpar}
% \codeblock{\begin{code}
%   ↑_ : E Γ is → E (Γ ▹ ip) is
%   ↑_ = wk v₀
% \end{code}}
% \and
% \codeblock{\begin{code}
%   ↑↑_ : E Γ is → E (Γ ▹ ip ▹ iq) is
%   ↑↑_ = ↑_ ∘ ↑_
% \end{code}}
% \end{mathpar}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{skip}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[2]\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wkv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{e₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₂}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x₁}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{x₁}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{keep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\<%
\end{code} 

\todo[inline]{Say something about substitution}
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ε}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{wks}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Ψ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Ψ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{wks}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[2]\AgdaFunction{wks}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wks}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaFunction{wk}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{sdrop}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{sdrop}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{wks}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{skip}\AgdaSpace{}%
\AgdaFunction{⊆-eq}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sdrop}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{subv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{subv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[2]\AgdaFunction{subv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{e₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₂}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x₁}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{x₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{x₁}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}∙ˢ\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Ψ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Ψ}\<%
\\
%
\>[2]\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∙ˢ}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[2]\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∙ˢ}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∙ˢ}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaFunction{sub}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{t}\<%
\end{code}
We can define identity substitution as folows:
\begin{code}%
%
\>[2]\AgdaFunction{sub-id}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{sub-id}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[2]\AgdaFunction{sub-id}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{skeep}\AgdaSpace{}%
\AgdaFunction{sub-id}\<%
\end{code}
As our context do not encode explicit dependencies between the variables,
we can easily define a substitution that swaps two top variables in the
context.  This will be used later for optimising programs in our DSL.
\begin{code}%
%
\>[2]\AgdaFunction{sub-swap}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Sub}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sub-swap}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sdrop}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sdrop}\AgdaSpace{}%
\AgdaFunction{sub-id}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\<%
\end{code}

\paragraph{Syntax}
\todo[inline]{Explain that we want to simplify the life of programers by
introducing HOAS-like syntax, which is difficult, as our DSL is intrinsically-typed.}

\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Syntax}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{L}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{)}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{instance}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[6]\AgdaInductiveConstructor{suc}%
\>[11]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ A\ term\ that\ can\ be\ lifted\ into\ larger\ contexts}\<%
\\
%
\>[2]\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{GE}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{is}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ A\ variable\ that\ can\ be\ lifted\ into\ larger\ contexts}\<%
\\
%
\>[2]\AgdaFunction{GVar}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{GVar}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Lift\ var}\<%
\\
%
\>[2]\AgdaFunction{V}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{GVar}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{V}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaFunction{V}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}%
\>[17]\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\end{code}
We can implement HOAS operators that will allow to use bound variables
under further binders.
\begin{code}%
%
\>[2]\AgdaComment{--\ Use\ GE\ GVar\ and\ V\ to\ define\ HOAS-style\ imap,\ imaps,\ and\ impab}\<%
\\
%
\>[2]\AgdaFunction{Imap}%
\>[1600I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1600I]%
\>[7]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[7]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\end{code}
We do the same wrappers for \AC{sum}, \AC{imaps}, \AC{imapb}, and the one
for \AC{let′}, providing a familiar let-like syntax.
\begin{code}[hide]%
%
\>[2]\AgdaFunction{Sum}%
\>[1637I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[1637I][@{}l@{\AgdaIndent{0}}]%
\>[7]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[7]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{Imaps}%
\>[1672I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1672I]%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaFunction{unit}\AgdaSymbol{))}\<%
\\
%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{Imaps}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imaps}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{Imapb}%
\>[1707I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1707I]%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{*}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{q}\<%
\\
%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{q}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{Imapb}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaFunction{Let-syntax}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{))}\<%
\\
%
\>[6]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\<%
\\
%
\>[6]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{Let-syntax}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{let′}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaKeyword{syntax}\AgdaSpace{}%
\AgdaFunction{Let-syntax}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(λ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaBound{e'}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaFunction{:=}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaFunction{In}\AgdaSpace{}%
\AgdaBound{e'}\<%
\end{code}

The final convenience operator that we are missing is the ability
to represent contexts in the HOAS style.
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaFunction{Let-syntax}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Extend\ context\ with\ a\ list\ of\ types}\<%
\\
%
\>[2]\AgdaComment{--\ (List\ is\ a\ context\ that\ grows\ to\ the\ left)}\<%
\end{code}
First of all, we define a helper function that appends a list of \AF{IS}
at the end of some context \AF{Γ}:
\begin{code}%
%
\>[2]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[2]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
%
\>[2]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ext}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{l}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaComment{--\ Turn\ the\ list\ of\ IS\ into\ the\ following\ function:}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ l\ =\ [a,\ b,\ c]}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ X\ =\ X}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ Γ\ =\ Γ}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ ----------------------------}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ GE\ Γ\ a\ →\ GE\ Γ\ b\ →\ GE\ Γ\ c\ →\ X}\<%
\\
%
\>[2]\AgdaFunction{lfunh}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{X}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{lfunh}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{X}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{X}\<%
\\
%
\>[2]\AgdaFunction{lfunh}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{X}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{GE}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{lfunh}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{X}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Diagonalise\ lfunh:}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ l\ =\ [a,\ b]}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ Γ\ =\ Γ}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ is\ =\ is}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ ---------------------------------------------}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ GE\ (ext\ Γ\ l)\ a\ →\ GE\ (ext\ Γ\ l)\ →\ E\ (ext\ Γ\ l)\ is}\<%
\end{code}
Then, we define \AF{lfun} that for the given list of \AF{IS}-es
(l = [is₁, \dots, isₙ]), some context \AF{Γ} and some \AF{IS}
ip computes an Agda function of type (\AF{GE} (\AF{ext} \AF{Γ} l) is₁ →
\dots → \AF{GE} (\AF{ext} \AF{Γ} l) isₙ → \AD{E} (\AF{ext} Γ l) ip).
The function \AF{lvar} lifts a variable in some context Γ into
an extended context.
\begin{code}%
%
\>[2]\AgdaFunction{lfun}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSymbol{)}%
\>[24]\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{is}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{lvar}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{GE}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{lfun}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{τ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lfunh}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{τ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{lvar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{V}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{lvar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lvar}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Apply\ function\ to\ the\ corresponding\ variables\ of\ the\ context}\<%
\end{code}
With these helper functions we define the \AF{Lcon} helper that
for the given list of types $l$, resulting type \AB{is}, the initial
context Γ and the function of type \AF{lfun} l Γ \AB{is} computes
the expression in the context \AF{ext} Γ l.
\begin{code}%
%
\>[2]\AgdaFunction{Lcon}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{lfun}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{is}\<%
\\
%
\>[2]\AgdaFunction{Lcon}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}%
\>[15]\AgdaBound{is}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{f}\<%
\\
%
\>[2]\AgdaFunction{Lcon}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Lcon}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{lvar}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\end{code}
This means that we can bind the last $n$ elements of the
context to Agda variables and use them safely under binders.
For example, consider this expression:
\begin{code}%
%
\>[2]\AgdaFunction{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[1957I]\AgdaFunction{Lcon}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
\>[.][@{}l@{}]\<[1957I]%
\>[6]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{i}\<%
\end{code}
where we \AB{a} and \AB{b} are bound to the arguments of
the Agda's lambda term and which are used when computing
expression in the context (ε ▹ 5 ∷ [] ▹ 5 ∷ 5 ∷ []). 



\paragraph{Primitives}
We are defining primitives that are needed for expresison our
running example in $E$.  We consider an example for the \AF{conv}-olution:
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Primitives}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{L}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{ℕ}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}\$\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{it}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}∋\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{slide}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Syntax}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{WkSub}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{fromPrefix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{⊆}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{fromPrefix}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊆-eq}\<%
\\
%
\>[2]\AgdaFunction{fromPrefix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{skip}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{fromPrefix}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{wkp}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Prefix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{wkp}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{wk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{fromPrefix}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaOperator{\AgdaFunction{⟨\AgdaUnderscore{}⟩}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{GE}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{⟨\AgdaUnderscore{}⟩}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{wkp}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{t}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaFunction{conv}%
\>[2074I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{+}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{suc}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSpace{}%
\AgdaSymbol{⦄}\<%
\\
\>[.][@{}l@{}]\<[2074I]%
\>[7]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{conv}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{s+p}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaBound{g}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{ss}\AgdaSpace{}%
\AgdaSymbol{⦄}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{s+p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{ss}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaFunction{Imaps}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{g}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[2136I]\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{+}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{inp}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{r}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ws}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{u}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[2136I]%
\>[10]\AgdaSymbol{(}\AgdaBound{bᵥ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{u}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{suc}}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{≈}}\AgdaSpace{}%
\AgdaGeneralizable{w}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{u}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaGeneralizable{w}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{sp}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaBound{inp}\AgdaSpace{}%
\AgdaBound{wᵥ}\AgdaSpace{}%
\AgdaBound{bᵥ}\AgdaSpace{}%
\AgdaSymbol{⦃}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaSymbol{⦄}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{conv}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{inp}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{wᵥ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaFunction{Imaps}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{bᵥ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{avgp₂}%
\>[2209I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{ℕ.*}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{ℕ.*}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)))}\<%
\\
\>[.][@{}l@{}]\<[2209I]%
\>[8]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{avgp₂}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{Imaps}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaFunction{it}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{sqerr}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{sqerr}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{o}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{o}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{meansqerr}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{meansqerr}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{sqerr}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sels}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟨}}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⟩}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\end{code}
where \AF{⟨\_⟩} lifts an expression into a generalised expression
simply by applying weakening according to the prefix.

Finally, the CNN embedded in $E$ is given as follows:
\begin{code}%
%
\>[2]\AgdaFunction{cnn}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{cnn}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[2321I]\AgdaFunction{Lcon}%
\>[2322I]\AgdaSymbol{(}%
\>[16]\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{28}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{28}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>[2322I][@{}l@{\AgdaIndent{0}}]%
\>[14]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}%
\>[34]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[14]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}%
\>[34]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[14]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}%
\>[34]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[14]\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[2322I]%
\>[13]\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
\>[.][@{}l@{}]\<[2321I]%
\>[8]\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{inp}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaBound{b₁}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{target}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{c₁₁}\AgdaSpace{}%
\AgdaFunction{:=}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaBound{inp}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaBound{b₁}%
\>[36]\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{c₁}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{c₁₁}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{s₁}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{avgp₂}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{c₂₁}\AgdaSpace{}%
\AgdaFunction{:=}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaBound{s₁}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{c₂}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{c₂₁}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{s₂}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{avgp₂}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{o₁}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaBound{s₂}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{o}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{o₁}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaFunction{Let}\AgdaSpace{}%
\AgdaBound{e}%
\>[16]\AgdaFunction{:=}\AgdaSpace{}%
\AgdaFunction{meansqerr}\AgdaSpace{}%
\AgdaBound{target}\AgdaSpace{}%
\AgdaBound{o}\AgdaSpace{}%
\AgdaFunction{In}\<%
\\
%
\>[8]\AgdaBound{e}\<%
\\
\>[0]\<%
\end{code}

% \paragraph{Building Blocks}
% Now we implement the remaining building blocks in \AD{E} that are needed
% to define our CNN.
% \begin{code}[hide]
% module BB where
%   open import Data.Nat as ℕ using (ℕ; zero; suc)
%   open Array hiding (sum; slide; backslide)
%   open Lang
%   open SubWk using (wk; ↑_; ↑↑_)
% 
%   --_⊞_ _⊠_ : (a b : E Γ (ar s)) → E Γ (ar s)
%   Imapₛ : (E (Γ ▹ ix s) (ix s) → E (Γ ▹ ix s) (ar unit)) → E Γ (ar s)
%   Imap : (E (Γ ▹ ix s) (ix s) → E (Γ ▹ ix s) (ar p)) → E Γ (ar (s ⊗ p))
%   Sum : (E (Γ ▹ ix s) (ix s) → E (Γ ▹ ix s) (ar p)) → E Γ (ar p)
% \end{code}
% We start with a several convenience functions that wrap \AC{imap}s and \AC{sum}
% such that when we write (\AF{Imap} \AB{λ} \AB{i} \AB{→} \AB{⋯}), Agda's variable
% $i$ is mapped to the \AF{E}'s variable \AC{v₀}.
% \begin{mathpar}
% \codeblock{\begin{code}
%   Imapₛ f = imapₛ (f (var v₀))
% \end{code}}
% \and
% \codeblock{\begin{code}
%   Imap f = imap (f (var v₀))
% \end{code}}
% \and
% \codeblock{\begin{code}
%   Sum f = sum (f (var v₀))
% \end{code}}
% \end{mathpar}
% 
% The remaining operations are \AF{conv}, \AF{mconv} and \AF{avgp₂} which
% can be defined as functions on \AF{E} as follows.
% \begin{code}
%   conv : E Γ (ar r) → s + p ≈ r → E Γ (ar s) → suc p ≈ u → E Γ (ar u)
%   conv f sp g su = Sum λ i → slide i sp (↑ f) su ⊠ Imapₛ λ _ → selₛ (↑↑ g) (↑ i)
% 
%   mconv : s + p ≈ r → (inp : E Γ (ar r)) (we : E Γ (ar (u ⊗ s))) (b : E Γ (ar u))
%         → suc p ≈ w → E Γ (ar (u ⊗ w))
%   mconv sp inp we b su = Imap λ i → conv (↑ inp) sp (sel (↑ we) i) su ⊞ Imapₛ λ _ → selₛ (↑↑ b) (↑ i)
% 
%   avgp₂ : ∀ m n → (a : E Γ (ar (ι (m ℕ.* 2) ⊗ ι (n ℕ.* 2)))) → E Γ (ar (ι m ⊗ ι n))
%   avgp₂ m n a = Imapₛ λ i → scaledown 4 $ Sum λ j → selₛ (selb (ι ⊗ ι) (↑↑ a) (↑ i)) j
% 
% \end{code}
% Note that these definitions are not very different from those found in
% Section~\ref{sec:array-theory}.  Some operations such as \AF{nest} and \AF{unnest}
% got inlined into \AF{E}'s operators, and all we really have to take care of is 
% weakening of the expressions whenever we go under binders.

