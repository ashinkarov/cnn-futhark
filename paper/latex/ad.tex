\begin{code}[hide]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Nullary}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{--\ Our\ local\ files.}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{arrays}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{lang}\<%
\\
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}

\section{Automatic Differentiation\label{sec:ad}}

We implement automatic differentiation in reverse mode
for expressions in \AF{E}.  We focus on reverse mode because it is
of most interest in machine learning, and it is more challenging to implement.
We start with a brief introduction of the AD, for much more in-depth
explanations refer to~\cite{autodiff-survey, backprop-stlc}.   Consider differentiating
a function composition consisting of three functions:
\[ 
   y = (f \circ g \circ h)\ x
\]
rewrite it using temporary variables:
\begin{eqnarray*}
  w_0 &=& x \\
  w_1 &=& h\ w_0 \\
  w_2 &=& g\ w_1 \\
  w_3 &=& f\ w_2 = y
\end{eqnarray*}
The chain rule gives us 
$\frac{\partial y}{\partial x} 
  = \frac{\partial y}{\partial w_2}
    \frac{\partial w_2}{\partial w_1}
    \frac{\partial w_1}{\partial x}$.  The difference between the forward and reverse
    mode lies in the direction that we traverse the chain rule.  In forward mode we
    traverse the chain inside-out, and the revers mode traverses the chain outside-in
    thus computing recursive relation:
$\frac{\partial y}{\partial w_i}
  = \frac{\partial y}{\partial w_{i+1}}
    \frac{\partial w_{i+1}}{\partial w_i}$.  For our example, we compute
$\frac{\partial y}{\partial w_2}$, then $\frac{\partial w_2}{\partial w_1}$ and
finally $\frac{\partial w_1}{\partial x}$.  While there seem to be no difference for
functions of one variable, there is a big difference for functions of $n$ variables
as we can compute derivatives of all the non-dependent variables simultaneously.
Consider an example of the $z = f\ x\ y = sin(xy + x)$:
\begin{eqnarray*}
  w_0 &=& x \\
  w_1 &=& y \\
  w_2 &=& w_1w_2\\
  w_3 &=& w_2 + w_0 \\
  w_4 &=& \sin w_3 = z
\end{eqnarray*}
We compute the adjoints $\bar{w}_i = \frac{\partial y}{\partial w_i}$ using the following
rule.  If $w_i$ has successors in the computational graph, we can apply the chain rule
as follows:
\[ 
    \bar{w}_i = \sum_{j \in succ\ i} \bar{w}_j\frac{\partial w_j}{\partial w_i}
\]
For our example:
\begin{eqnarray*}
  \bar{w}_4 &=& 1 = \frac{\partial z}{\partial z} \\
  \bar{w}_3 &=& \bar{w}_4 \cos w_3\\
  \bar{w}_2 &=& \bar{w}_3 \cdot 1 \\
  \bar{w}_1 &=& \bar{w}_2 w_0 \\
  \bar{w}_0 &=& \bar{w}_3 + \bar{w}_2 w_1
\end{eqnarray*}
If we inline all the $\bar{w}_i$ definitions and inspect the values of partial derivatives
with respect to $x$ and $y$ we obtain expected results:
$\frac{\partial z}{\partial x} = \cos (xy + x)(y + 1)$ and
$\frac{\partial z}{\partial y} = \cos (xy + x)x$.


In the implementation of the AD for \AF{E} in some context \AB{Γ}, we would like to obtain
all the partial derivatives with respect to the variables in context \AB{Γ}.  Each partial
derivative is itself an expression \AF{E} in context \AF{Γ}.  Therefore, we need to define
a data type for an environment of \AB{Γ}-many expressions in context \AB{Γ}.  We call this
environment \AF{Env} defined as follows:
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{AD}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{Prod}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{backslide}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{slide}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{SubWk}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Left-associated\ pairing}\<%
\\
%
\>[2]\AgdaKeyword{infixl}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{},,\AgdaUnderscore{}}}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{},,\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{X}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{Y}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{X}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaGeneralizable{Y}\<%
\\
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{},,\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{Prod.\AgdaUnderscore{},′\AgdaUnderscore{}}}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}%
\>[18]\AgdaBound{Δ}%
\>[21]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}%
\>[18]\AgdaBound{Δ}%
\>[21]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}%
\>[18]\AgdaBound{Δ}%
\>[21]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\end{code}
Note that \AF{Env} only keeps array expressions, as (i) derivatives for indices do
not exist; and (ii) we can always make an initial environment by populating all the
elements with \AC{zero}s.  

We define several helper operations to manipulate environments: \AF{env-zero} is 
an environment where all the values are \AC{zero}s; \AF{update} modifies the 
expression at the $v$-th position by applying $f$ to it; \AF{env-map} applies the function
$f$ from \AF{E} to \AF{E} to all the elements of the environment; and \AF{env-zipWith}
applies the binary function $f$ on two environments point-wise.  The types of these
helper functions follow.  As environments are very similar to lists, the implementation
of the above functions are straight-forward.
\begin{code}%
%
\>[2]\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{update}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{Ψ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Ψ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Ψ}\<%
\\
%
\>[2]\AgdaFunction{env-zipWith}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaBound{Ψ}\AgdaSpace{}%
\AgdaBound{Ξ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Ψ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Ξ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\<%
\\
%
\>[15]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Ψ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Ξ}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{update}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaFunction{update}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{update}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{f}\<%
\\
%
\>[2]\AgdaFunction{update}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{update}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[2]\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Update\ array\ values\ in\ the\ environment}\<%
\\
%
\>[2]\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaComment{--→\ Env\ Γ\ Δ}\<%
\\
%
\>[2]\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}%
\>[23]\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[2]\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[2]\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[2]\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[2]\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\<%
\\
%
\>[2]\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{r}\<%
\\
%
\>[2]\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{e₂}\<%
\end{code}

We define the function \AF{∇} that takes an expression \AF{E} and the seed
which is the multiplier on the left of the chain, and we compute a function
from that updates the environment.
\begin{code}%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{seed}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{ip}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\>[2]\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-zipWith}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊞\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\})))}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{one}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{update}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}⊞}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}%
\>[52]\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}%
\>[52]\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}%
\>[52]\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapₛ}%
\>[47]\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}%
\>[47]\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}%
\>[47]\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{map-sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{∘}}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{su}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaBound{su}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}%
\>[27]\AgdaBound{s}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)))}\<%
\end{code}
Let us now walk through the cases.  Derivative of constants (\AC{zero} and \AC{one})
is zero, so nothing needs to be updated in the environment.  Index variables are
not stored in the environment, so no updates are needed either.  If we differentiate
the variable $x$ with some seed \AB{s}, we update the $x$-th position in the environment
by adding \AB{s} to it.  Differentiation of \AC{imap}s proceeds as follows: we
recursively apply \AF{∇} to $e$ (in the context \AB{Γ} \AC{▹} (\AC{ix} \AB{p}))
with the element of the original seed \AB{s} selected at the top variable.  This
gives us the environment in the extended context, then we map \AC{sum} to every
element of the environment to accumulate the derivatives at every index.
When differentiating selections we recurse on the array we are
selecting from with the seed that is zero everywhere except the index we were
selecting at.  Differentiating
conditional is straight-forward, as $i$ and $j$ must be in the context, we can
simply differentiate $e$ with the condition on seed.  If indices were equal, we will
compute the update, otherwise we will differentiate with seed \AC{zero} which
has no effect.  As we are operating in a total language, there is no need to worry
about pulling the expression out of conditional.  The argument of \AC{sum}
lives is in the extended context, so we apply the same rules as for the \AC{imap} family,
except we propagate the original seed to all the summands.  Addition and multiplication
rules are straight-forward application of differentiation rules.  The \AC{slide}/\AC{backslide}
pair forms a satisfying \AF{∇}-symmetry.  Finally, \AC{scaledown}, \AC{minus} and
\AC{logistic} follow the rules of differentiation.





\subsection{Optimisation\label{sec:opt}}

Our algorithm often delivers expressions that are not computationally efficient.
While we can hope for the backend to take care of this, it is relatively
easy to implement a number of rewriting rules prior to extraction.  
We constructed \AF{E} such that no computation is happening in the shape
or context positions.  As a result, dependent pattern-matching is always
applicable on \AF{E} expressions, and our optimisations can be formulated
very concisely.  We omit constant-folding like rewrites such as addition
with zero and multiplication by one and focus on less trivial cases that have
to do with selections a+nd sum.  Consider the snippet of the optimiser for
\AF{selₛ} and \AF{sum}.

\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Opt}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{ℕ}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{SubWk}\<%
\\
%
\>[2]\AgdaComment{--open\ Eval\ using\ (sub;\ ctx-swap;\ ↑\AgdaUnderscore{};\ ↑↑\AgdaUnderscore{};\ eq?)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{slide}\AgdaSymbol{;}\AgdaFunction{backslide}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{BB}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{AD}\<%
\end{code}
\begin{code}%
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e₁}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{one}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{a}%
\>[24]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}%
\>[24]\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{a}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}%
\>[35]\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ctx-swap}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{a}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}%
\>[35]\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ctx-swap}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{a}%
\>[24]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}%
\>[35]\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ctx-swap}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{eq?}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{eq?}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{eq}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{eq}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{neq}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaBound{i′}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{eq}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{i′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{eq}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{neq}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaBound{j′}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{j′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{neq}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaBound{i′}%
\>[18]\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{neq}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaBound{j′}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{i′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{j′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaFunction{opt}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{sum}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaComment{--\ ⋯}\<%
\end{code}
Selection into \AC{zero} and \AC{one} is \AF{zero} and \AC{one}, as our constants
are shape-polymorphic.  Selection into an \AF{imapₛ} is evaluation of the \AC{imapₛ}
body at the given index (this is an array version of the $\beta$-rule).  Selection
from the binary operation is a binary operation of selections.  Selection into \AC{sum}
is the \AC{sum} of selections.  Selection into conditional is the same as conditional
over selection.  Summing \AC{zero} is \AC{zero}.  Summing $s$-many $p$-shaped arrays
is the same as computing the sum of $i$-th index of every array for all $p$ indices.
If we have a sum of the conditional with the predicate is the equality of indices
$i$ and $j$ and we know that $i$ and $j$ are variables, we can compare the index
variable of the \AC{sum} with $i$ and $j$.  If they match, then conditional will
be triggered at every iteration so it can be removed.  If only one of them match,
and we are comparing variables of the same shape, there will be exactly one case
(for non-empty shapes) where this conditional will be triggered.  Therefore, all
the iterations except the one at the non-matching variable will turn to zero, and
we can simply return the expressions substituted at this variable.  If the shape
of the index variables is empty, we are in the absurd case, as we cannot possibly
create an element of an empty type.  Finally, if none of the variables match,
the iteration within the \AC{sum} do not affect the result of the predicate ---
it will be either true or false for all the iterations.  Therefore, we can lift
the conditional outside of the sum.
\begin{code}[hide]%
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaComment{--\ Literal\ copy\ of\ the\ above,\ replaing\ scalar\ versions}\<%
\\
%
\>[2]\AgdaComment{--\ with\ normal\ one}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e₁}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{sub}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\>[2]\AgdaComment{--...\ |\ imapb\ m\ e\ |\ i\ =\ ?}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{wk}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaComment{--\ Literal\ copy\ of\ the\ above\ for\ the\ blocked\ version}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaComment{\{-\ var\ \$\ vₛ\ k-\}}\AgdaSymbol{))}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{op}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaFunction{opt}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{selb}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{j}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
\>[0]\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{eq?}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{eq}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{neq}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaComment{--opt\ (zero-but\ i\ j\ e)\ =\ zero-but\ i\ j\ (opt\ e)}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e₁}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{zero}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{zero-but}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{j}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{zero-but}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{j}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapₛ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapₛ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imap}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imap}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapb}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapb}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e₁}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{zero}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{one}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{one}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{zero-but}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{j}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{zero-but}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{i}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{j}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{e}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapₛ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapₛ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imap}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imap}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapb}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)))}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaInductiveConstructor{imapb}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{b}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaComment{--\ XXX:\ not\ calling\ opt\ on\ e,\ as\ this\ is\ index}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{su}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{su}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaBound{pl}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{y}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{ℕ.*}}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaComment{--\ TODO:\ propogate\ minues\ inside\ of\ +,\ *,\ imap,\ etc.}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[2]\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{a}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\<%
\\
%
\>[2]\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{opt}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{TryOpt}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}

Let us observe optimisation effects when computing derivatives of
the scalar dot-product defined as follows.
\begin{code}%
\>[2][@{}l@{\AgdaIndent{1}}]%
\>[4]\AgdaFunction{dotp}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaFunction{unit}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaFunction{dotp}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{i}\<%
\end{code}
\begin{code}[hide]%
%
\>[4]\AgdaFunction{C}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[4]\AgdaFunction{a}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaFunction{C}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[4]\AgdaFunction{b}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaFunction{C}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[4]\AgdaFunction{seed}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaFunction{C}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\end{code}
We define the context \AF{C} where two top variables are of 5-element vector shape
and the last variable (\AC{v₂}) is of scalar shape.  We bind these variables to Agda
variables for convenience.
\begin{code}%
%
\>[4]\AgdaFunction{C}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}%
\>[13]\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}%
\>[28]\AgdaOperator{\AgdaInductiveConstructor{▹}}%
\>[31]\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{)}%
\>[43]\AgdaOperator{\AgdaInductiveConstructor{▹}}%
\>[46]\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{);}\<%
\\
%
\>[13]\AgdaFunction{seed}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₂}%
\>[28]\AgdaSymbol{;}%
\>[31]\AgdaFunction{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}%
\>[43]\AgdaSymbol{;}%
\>[46]\AgdaFunction{b}%
\>[49]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\end{code}
\begin{code}[hide]%
%
\>[4]\AgdaFunction{∂a}%
\>[11]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaFunction{C}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{∇}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaFunction{C}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dotp}\AgdaSpace{}%
\AgdaFunction{a}\AgdaSpace{}%
\AgdaFunction{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaFunction{seed}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{env-zero}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaFunction{C}\AgdaSymbol{\}))}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\<%
\\
%
\>[4]\AgdaFunction{∂a′}%
\>[11]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSpace{}%
\AgdaFunction{∂a}\<%
\end{code}
We compute the derivatives of \AF{dotp a b} with seed \AF{seed} and we inspect
the $a$-th position in the returned environment that we call \AF{∂a}.  Then we repeatedly
apply \AF{opt} (three times) to \AF{∂a} and save it in \AF{∂a′}.  We force Agda to
verify that the content of the variables is as follows:
\begin{code}%
%
\>[4]\AgdaFunction{non-opt}%
\>[14]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{∂a}%
\>[21]\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Sum}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaFunction{Imapₛ}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaFunction{seed}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaFunction{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
%
\>[4]\AgdaFunction{with-opt}%
\>[14]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{∂a′}%
\>[21]\AgdaOperator{\AgdaDatatype{≡}}\AgdaSpace{}%
\AgdaFunction{Imapₛ}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaFunction{seed}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaFunction{b}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\end{code}
\begin{code}[hide]%
%
\>[4]\AgdaFunction{non-opt}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\>[4]\AgdaFunction{with-opt}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaComment{--\ open\ Lang}\<%
\\
\>[0]\AgdaComment{--\ open\ SubWk}\<%
\end{code}
As it can be seen, \AF{∂a} sums-up the arrays, where only one element is non-zero at
every iteration.  Such a computation is highly inefficient when executed directly,
as it needs to compute all the inner arrays before summing them up.  However, the
optimised version correctly rewrites \AF{∂a} into \AC{imap} that multiplies
the \AB{seed} by $b$, which is the expected answer.  This reduces complexity
of the expression form squared to linear.

\subsection{Extraction}

Extraction from \AF{E} into SaC translates constructors of \AF{E} into
corresponding SaC expressions or function calls.  The translation starts with
a definition of an environment (\AF{SEnv} \AB{Γ}) that assigns SaC variable names
to all positions in \AB{Γ}.  The assumption here is that when we compile
expressions in context \AF{Γ}, variable names of the corresponding shapes are
available in SaC.

Next, we have to take care of shapes.  Array shapes in \AF{E} are binary trees,
but array shapes in SaC are 1-dimensional arrays (flattened binary trees).
When some expression in \AF{E} is of product shape, we usually have to
supply left or right subshapes of the product to SaC. These are always available
through implicit arguments of \AF{E} constructors. Assuming that by the
time we come to extraction, all the \AF{E} shapes are constants, we can
always generate shape expressions in SaC.  This is implemented in \AF{show-shape}.
Relaxing the assumption about constant shapes is possible but requires
extension of \AF{E} so that we can always bind the shapes used in \AF{E}
to some expressions in SaC.

We also need a source of fresh variables so that we can generate indices
for \AC{imap} expressions.  We define a stateful function \AF{iv} that
generates a fresh index variable.  

Extraction is given by \AF{to-sac} that translates the expression $e$ in
the environment $\rho$.  The function is stateful so that we can generate
fresh variables when needed.

The definitions of \AF{SEnv}, \AF{iv}, {\AF{show-shape}, and \AF{to-sac} follow.
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Sac}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{L}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}++\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{ℕ}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat.Show}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{()}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{show}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaFunction{show-nat}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.String}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}++\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Text.Printf}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Category.Monad.State}\AgdaSpace{}%
\AgdaComment{--using\ (State;\ StateMonad;\ RawMonadState)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Category.Monad}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{RawMonad}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaComment{--open\ RawMonad\ \{\{...\}\}\ public}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{RawMonadState}\AgdaSpace{}%
\AgdaSymbol{\{\{...\}\}}\AgdaSpace{}%
\AgdaKeyword{public}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{slide}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{backslide}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{SubWk}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{instance}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaComment{--\ stateMon\ :\ ∀\ \{S\ :\ Set\}\ →\ RawMonad\ (State\ S)}\<%
\\
%
\>[4]\AgdaComment{--\ stateMon\ \{S\}\ =\ StateMonad\ S}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{stateMonState}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{S}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{RawMonadState}\AgdaSpace{}%
\AgdaBound{S}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaBound{S}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaFunction{stateMonState}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{S}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{StateMonadState}\AgdaSpace{}%
\AgdaBound{S}\<%
\end{code}
\begin{mathpar}
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}%
\>[17]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
%
\>[2]\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{is}\AgdaSymbol{)}%
\>[17]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{iv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}%
\>[13]\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaField{get}\<%
\\
%
\>[13]\AgdaFunction{modify}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\<%
\\
%
\>[13]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"x\%u"}\AgdaSpace{}%
\AgdaBound{v}\<%
\end{code}
\begin{code}[hide]%
\>[0]\<%
\\
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}%
\>[17]\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[17]\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ show-shape\ :\ S\ →\ String}\<%
\\
%
\>[2]\AgdaComment{--\ show-shape\ (ι\ x)\ =\ show-nat\ x}\<%
\\
%
\>[2]\AgdaComment{--\ show-shape\ (s\ S.⊗\ p)\ =\ printf\ "⟨\%s,\ \%s⟩"\ (show-shape\ s)\ (show-shape\ p)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{fresh-var}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{fresh-var}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"x\%u"}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{bop}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Bop}\AgdaSpace{}%
\AgdaSymbol{->}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{bop}\AgdaSpace{}%
\AgdaInductiveConstructor{plus}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaString{"+"}\<%
\\
%
\>[2]\AgdaFunction{bop}\AgdaSpace{}%
\AgdaInductiveConstructor{mul}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaString{"*"}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{dim}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\<%
\\
%
\>[2]\AgdaFunction{dim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaNumber{1}\<%
\\
%
\>[2]\AgdaFunction{dim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{Array.⊗}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dim}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{ℕ.+}}\AgdaSpace{}%
\AgdaFunction{dim}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{ivl}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSpace{}%
\AgdaPostulate{String}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{ivl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaField{get}\<%
\\
%
\>[4]\AgdaFunction{modify}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\<%
\\
%
\>[4]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{fresh-var}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{ivl}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{S.⊗}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{ivl}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[4]\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{ivl}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[4]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{L.++}}\AgdaSpace{}%
\AgdaBound{r}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaComment{--iv\ s\ =\ printf\ "[\%s]"\ ∘\ intersperse\ ",\ "\ <\$>\ ivl\ s}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{s}%
\>[1867I]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"[\%s]"}\<%
\\
\>[.][@{}l@{}]\<[1867I]%
\>[15]\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{intersperse}\AgdaSpace{}%
\AgdaString{",\ "}\<%
\\
%
\>[15]\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{go}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaFunction{go}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[6]\AgdaFunction{go}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[18]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-nat}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\>[6]\AgdaFunction{go}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}%
\>[18]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{go}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaFunction{go}\AgdaSpace{}%
\AgdaBound{p}\<%
\end{code}}
\and
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}%
\>[1927I]\AgdaString{"\{\ \%s\ ->\ \%s\ |\ \%s\ <\ \%s\ \}"}\<%
\\
\>[.][@{}l@{}]\<[1927I]%
\>[21]\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"(\%s)[\%s]"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<\$>}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊛}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[2]\AgdaComment{--\ ⋯}\<%
\end{code}}
\end{mathpar}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{return}\AgdaSpace{}%
\AgdaString{"zero"}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaInductiveConstructor{one}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{return}\AgdaSpace{}%
\AgdaString{"one"}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{lookup}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapₛ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaComment{--return\ \$\ printf\ "\{\ \%s\ ->\ \%s\ |\ \%s\ <\ \%s\ \}"\ i\ b\ i\ sh}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"IMAPS(\%s,\ (\%s),\ (\%s))"}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{sh}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selₛ}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaComment{--return\ \$\ printf\ "(\%s)[\%s]"\ a\ i}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"sels(\%s,\ \%s)"}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Copy-paste\ from\ scalar\ versions}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Copy-paste\ from\ scalar\ versions}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{imapb}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}\{}\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"unblock(\{\ \%s\ ->\ \%s\ |\ \%s\ <\ \%s\ \},\ \%s)"}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{sh-s}\AgdaSpace{}%
\AgdaBound{sh-p}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{selb}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"selb(\%s,\ \%s,\ \%s)"}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{sh-p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{zero-but}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"\%s\ ==\ \%s\ ?\ \%s\ :\ zero"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<\$>}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊛}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊛}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sum}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaComment{--\ outer\ index\ }\<%
\\
%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaComment{--\ inner\ index\ which\ is\ juts\ a\ fresh\ name}\<%
\\
%
\>[5]\AgdaBound{j}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{iv}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[5]\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{)}\<%
\\
%
\>[5]\AgdaComment{--\ `s`\ is\ outer\ shape,\ and\ `p`\ is\ the\ inner\ one}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-s}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{s}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[5]\AgdaComment{--return\ \$\ printf\ "sumOuter(\%u,\ \{\ \%s\ ->\ \%s\ |\ \%s\ <\ \%s\})"\ (dim\ s)\ i\ b\ i\ sh-s}\<%
\\
%
\>[5]\AgdaComment{--\ sumOuter(ivOuter,\ ivInner,\ e,\ shOuter,\ shInner)}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"sumOuter(\%s,\ \%s,\ \%s,\ (\%s),\ (\%s))"}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{sh-s}\AgdaSpace{}%
\AgdaBound{sh-p}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bin}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"(\%s)\ \%s\ (\%s)"}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{bop}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{b}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{slide}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{su}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"slide(\%s,\ \%s,\ \%s)"}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{sh-p}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{backslide}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{r}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{r}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{su}\AgdaSpace{}%
\AgdaBound{pl}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{i}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e₁}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{sh-sp}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{show-shape}\AgdaSpace{}%
\AgdaBound{r}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"backlide(\%s,\ \%s,\ \%s)"}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaBound{sh-sp}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{scaledown}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[5]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[5]\AgdaFunction{return}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"(\%s)\ /\ \%s"}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{show-nat}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"-(\%s)"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<\$>}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\>[2]\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"logistics(\%s)"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<\$>}}\AgdaSpace{}%
\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ This\ can\ be\ made\ stateful,\ but\ we\ are\ assuming\ that}\<%
\\
%
\>[2]\AgdaComment{--\ vₛ\ is\ no\ need\ to\ make\ imap/sum\ index\ variables\ unique.}\<%
\\
%
\>[2]\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{AD.Env}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{vars}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaString{"--"}\<%
\\
%
\>[2]\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-sac}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-sac}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaBound{σ}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ Reversed\ environment\ to\ list}\<%
\\
%
\>[2]\AgdaFunction{env-rev-list}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{env-rev-list}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}%
\>[23]\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\>[2]\AgdaFunction{env-rev-list}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaFunction{env-rev-list}\AgdaSpace{}%
\AgdaBound{ρ}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaComment{--\ zipWith\ for\ Environments}\<%
\\
%
\>[2]\AgdaFunction{zip-env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPostulate{String}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{zip-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}%
\>[18]\AgdaBound{f}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}%
\>[28]\AgdaInductiveConstructor{tt}%
\>[36]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[2]\AgdaFunction{zip-env}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ν}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{zip-env}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{ν}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{e}\<%
\end{code}

\subsubsection{SaC Primitives\label{sec:sac-primitives}}
As can be seen from the two cases of \AF{to-sac}, the extraction process is
not complicated. In essence, we define a small snippet of SaC code for 
each \AF{E} constructor.  Consider the \AC{imap}/\AC{sel}
family from the code snippet.  The \AC{imap} constructor maps directly to SaC's
tensor comprehensions~\cite{tensor-comp} expressed as: \texttt{\{ iv -> e | iv < s \}}.
This expression constructs arrays by evaluating \texttt{e} for every array non-negative index
vector
\texttt{iv} whose components are element-wise smaller than the shape \texttt{s}.  The shape of the resulting
array is concatenation of \texttt{s} and whatever the shape of \texttt{e} is.
Selections \AC{sel} correspond to the built-in array selection using
C-like syntax \texttt{e[iv]} where \texttt{e} is the array we are selecting
from and \texttt{iv} is the index vector.   Shape constraints are exactly as in
\AF{E}: if \texttt{e} is of shape \texttt{s ++ p}, and \texttt{iv} is bounded
by \texttt{s} then \texttt{e[iv]} is of shape \texttt{p}.

Scalar versions of imap/sel require a little wrapping.  For \AC{imapₛ} we
generate a tensor comprehension that selects inner expressions (they are
1-element vectors) at zero-th position.  For \AC{selₛ} we make selection into
an array and we wrap the result in a 1-d vector:
\begin{mathpar}
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}[linewidth=.4\textwidth]
#define IMAPS(iv, e, shp) \
  {iv -> (e)[[0]] | iv < shp}
\end{lstlisting}
\end{varwidth}}
\and
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}[linewidth=.55\textwidth]
inline float[1]
sels(float[d:shp] x, int[d] iv)
{
  return [x[iv]];
}
\end{lstlisting}
\end{varwidth}}
\end{mathpar}
When translating (\AC{imapₛ} \{ \AB{s} \} \AB{e}) we pick a fresh index variable
\texttt{iv}, then we translate \AB{e} (in the environment extended with \texttt{iv})
into \texttt{e'} and we generate \texttt{IMAPS(iv, e', shp)}, where \texttt{shp} is
a translation of \texttt{s}.  On the side of SaC we expand this macro as shown
above.  We could have expanded this macro on the Agda side, but this abstraction
makes it possible to make adjustments in the generated code without running Agda.
We map \AC{selₛ} into the \texttt{sels} function.  Consider the type of \texttt{sels}
which uses the recently added feature of SaC that makes it possible to encode
shape constraints in types~\cite{type-pattern}.  While these constraints are potentially checked at runtime,
they are very useful for readability and they provide some confidence about the
generated code.  The meaning of the type \texttt{float[d:shp]} is that it is
an array of base type \texttt{float} of rank \texttt{d} and shape \texttt{shp}.
When a variable of the same name is used within different arguments, it automatically
triggers the equality constraint between the corresponding ranks/shapes.

\paragraph{Blocking} Implementation of \AC{selb}/\AC{imapb} pair relies on
the notion of blocking, so we introduce the analogue to \AF{block}/\AF{unblock}
functionality in SaC as follows:
\begin{mathpar}
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}[linewidth=.44\textwidth]
inline float[n:s,n:p]
block(float[n:sp] x, int[n] p)
     | all(s*p == sp)
     , all(p   >= 0)
{
  return { iv -> tile(p, iv * p, x) 
         | iv < sp / p};
}
\end{lstlisting}
\end{varwidth}}
\and
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}[linewidth=.55\textwidth]
inline float[n:sp] 
unblock(float[n:s,n:p] a, int[n] p)
       | all(s*p == sp)
       , all(p   >= 0)
{
  return { iv -> a[(iv / p) ++ mod (iv, p)]
         | iv < s*p};
}
\end{lstlisting}
\end{varwidth}}
\end{mathpar}
The type \texttt{float[n:s,n:p]} denotes an array of the shape \texttt{s ++ p}
where \texttt{s} and \texttt{p} are of length \texttt{n}.  This is a product
shape in terms of our array theory.  As \texttt{sp} is just a variable that
is not related to \texttt{s} or \texttt{p}, we add two constraints (expressions
behind the bar after the function definition) saying that: (i) \texttt{sp} is
a point-wise product of \texttt{s} and \texttt{p}; (ii) all the elements of
the \texttt{p}-shape are greater than zero.  Keep in mind that these are potential
runtime constraints, they may be proved or flagged as disproved during compilation
but they do not provide a static guarantee. The implementation of block uses the \texttt{tile}
operation from the standard library of SaC. It selects a sub-array of the given shape at the given position.
In \texttt{unblock} we use a division and a modulo operation to remap the indices.
When translating \AC{selb}, we simply select into \texttt{block}-ed array.
When translating \AC{imapb}, we use the tensor comprehension as in case of
\AC{imap} to compute blocked array and then we call \texttt{unblock} on it.

\paragraph{Sliding} Slides and backslides are translated into calls to
the following SaC functions:
\begin{mathpar}
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}
inline float[d:n1] 
slide(int[d] i, float[d:mn] x, int[d] n)       | all(n1        == n + 1)
                                               , all(n + 1 + i <= mn)
{
  return { iv -> x[iv + i] | iv < n + 1 };
}

inline float[d:mn]
backslide(int[d] i, float[d:n1] y, int[d] mn)  | all(i < 1 + mn - n1)
{
  return { iv -> y[iv - i] | i <= iv < n1 + i;
           iv -> 0f        |      iv < mn };
}
\end{lstlisting}
\end{varwidth}}
\end{mathpar}
Shape constraints become a little bit involved here because we implicitly
reconstruct the proof objects such as \AB{m} \AF{+} \AB{n} \AF{≈} \AB{mn}
and \AF{suc} \AB{n} \AF{≈} \AB{n1}.  Otherwise, \texttt{slide} selects a
sub-array of the shape (\texttt{n+1}) starting at the index \texttt{i}.
The \texttt{backslide} populates the sub-array with the elements of
\texttt{y} and the second partition of the tensor comprehension specifies
that all the other indices evaluate to zero.  Translation of \AC{slide}
and \AC{backslide} maps the arguments one-to-one, additionally providing
the $n$-shape in case of slide and the $(m+n)$ shape in case of backslide.

\paragraph{Summation} When translating (\AC{sum} \{\AB{s}\} \AB{e}), where
\AB{e} is of shape \AB{p} (and the index variable within the \AC{sum} is
bounded by \AB{s}), we map these arguments into the following SaC function:
\begin{lstlisting}
inline float[n:p] sumOuter(float[m:s,n:p] a, int[m] s, int[n] p) {
  return { jv -> sum({iv -> a[iv++jv] | iv < s}) | jv < p };
}
\end{lstlisting}
We use SaC's builtin \texttt{sum} function that sums-up all the elements
of the given array.

The rest of the constructions are mapped into regular arithmetic operations
that are provided by SaC.


\subsection{Local Variables}

The framework that we built so far computes derivatives of the variables in
the context.  This means that for complex expressions in \AF{E} (such as \AF{forward}),
all the let bindings will be inlined.  This is often not desirable both for performance
and readability.  Here we present a mechanism that introduce local variables
and preserves them during AD.
\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{DoubleChain}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaComment{--\ In\ this\ module\ I\ want\ to\ preserve\ derivatives}\<%
\\
%
\>[2]\AgdaComment{--\ of\ the\ local\ variables\ in\ the\ chain\ (instead\ of\ inlining\ them)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.String}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Text.Printf}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaComment{--using\ (Σ;\ \AgdaUnderscore{}×\AgdaUnderscore{};\ \AgdaUnderscore{},\AgdaUnderscore{})}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{ℕ}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{ℕ}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaSymbol{as}\AgdaSpace{}%
\AgdaModule{L}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Array}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{sum}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{slide}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{backslide}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lang}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{SubWk}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{AD}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Opt}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{BB}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\end{code}

The key data structure that makes it possible to introduce local variables
is called \AF{Chain} which has two constructors.  The empty chain consists
of the names for all the variables in the context \AB{Γ}.  This represents the
case where no local variables have been introduced.  The \AC{\_▹\_} constructor
takes a chain in context \AB{Δ} and the array expression of shape \AB{p} in
the same context together with the variable name.  This produces the chain
in the context extended by two variables.  One variable is a place-holder
for the expression and the other variable is a placeholder for the derivative
of that expression.
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ε}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Sac.SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPostulate{String}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{p}\AgdaSymbol{)}\<%
\end{code}

The computation of the derivative in \AF{Chain}s follows the following
simple idea.  Consider the chain with two variables $a$ and
$b$ in the initial context \AB{Γ}, and two local variables $x$ and $y$.
Here is what happens when we compute the derivative of some expression
$e$ (that may depend on $a$, $b$, $x$, $y$) with some seed $s$ in the
empty $\delta_0$ environment. 

%\begin{table}
\begin{center}
\begin{tabular}{cc|cccc|l}
   $a$         &$b$         &$\partial{x}$& $x$         &$\partial{y}$&$y$       & \text{compute $\nabla\ e\ s\ \delta_0$}\\
   \hline
   $\delta_a$  &$\delta_b$  &-            & $\delta_x$  &-            &$\delta_y$& \text{assign $\delta_y$ to $\partial{y}$}\\
   $\delta_a$  &$\delta_b$  &-            & $\delta_x$  &$\delta_y$   &$\delta_y$& \text{compute $\nabla\ y_e\ \partial{y}$}\\
   $\delta'_a$ &$\delta'_b$ &-            & $\delta'_x$ &$\delta_y$   &$\delta_y$& \text{assign $\delta'_x$ to $\partial{x}$}\\
   $\delta'_a$ &$\delta'_b$ &-            & $\delta'_x$ &$\delta_y$   &$\delta_y$& \text{compute $\nabla\ x_e\ \partial{x}$}\\
   $\delta''_a$ &$\delta''_b$ &$\delta'_x$  & $\delta'_x$ &$\delta_y$   &$\delta_y$& \text{done}
\end{tabular}
\end{center}
%\end{table}

First of all, the computation of $e$ returns the environment $\delta$ that can
be found in the first line of the table.  Then we repeat the following steps while
traversing the chain backwards: we copy the $y$-th position of the $\delta$-environment
to the $\partial{y}$-th position, and we compute the expression $y_e$ that is assigned to $y$
($xx$ in this case) with the seed $\partial{y}$-th variable.  Just to clarify, the seed
is the variable $\partial{y}$ and not its value.  Then we repeat the same process
for $x$ and potentially all the other remaining local variables (not in this case) until
we hit the beginning of the chain.

At the end of the process we obtain an environment where derivatives for $a$ and
$b$ are expressed in terms of $\partial{x}$ and $\partial{y}$.  The remaining step
is to collect the values of $\partial{x}$ and $\partial{y}$ which can be found
at the corresponding positions in the $\delta$-environment.
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LCtx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{[]}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LCtx}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}◃\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LCtx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LCtx}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}<><\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LCtx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[2]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\<%
\\
%
\>[2]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaBound{Δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LEnv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LCtx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{[]}%
\>[8]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LEnv}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}◃\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LEnv}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LEnv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{done}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[4]\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Ctx}\<%
\\
%
\>[2]\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[2]\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-to-env}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{Σ}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{chain-to-env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[23]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{done}\<%
\\
%
\>[2]\AgdaFunction{chain-to-env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaSymbol{(\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{po}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{chain-to-env}\AgdaSpace{}%
\AgdaBound{c}\<%
\\
%
\>[4]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑↑\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{po}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{pstep}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{pstep}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[2]\AgdaFunction{pstep}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[2]\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{no-ix}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{¬}}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{no-ix}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
%
\>[2]\AgdaFunction{no-ix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{next}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{no-ix}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{post-fish}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaGeneralizable{is}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{∈}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{post-fish}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
%
\>[2]\AgdaFunction{post-fish}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{post-fish}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{vₛ}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}%
\>[2736I]\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{LEnv}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
\>[.][@{}l@{}]\<[2736I]%
\>[12]\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Postfix}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaFunction{double-ctx}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{<><}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}%
\>[51]\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ε}\AgdaSymbol{\}}%
\>[19]\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{ρ′}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\>[2]\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ix}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaBound{ρ′}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{⊥-elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{no-ix}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{post-fish}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ρ′}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{let}\<%
\\
%
\>[4]\AgdaBound{ve}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}%
\>[34]\AgdaComment{--\ variable\ for\ e\ in\ Γ}\<%
\\
%
\>[4]\AgdaBound{vz}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{post-var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}%
\>[34]\AgdaComment{--\ variable\ for\ z\ in\ Γ}\<%
\\
%
\>[4]\AgdaBound{s}%
\>[7]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-ix}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaBound{ve}\<%
\\
%
\>[4]\AgdaBound{δ₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{update}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaBound{vz}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{const}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}%
\>[34]\AgdaComment{--\ save\ s\ in\ the\ z's\ position}\<%
\\
%
\>[4]\AgdaBound{δ₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{∇}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{vz}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{δ₁}%
\>[34]\AgdaComment{--\ use\ vz\ position\ as\ seed}\<%
\\
%
\>[4]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{z}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{ρ′}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{pstep}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{◃}}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{pstep}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Δ′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Δ′}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{δ₂}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-grad}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaGeneralizable{s}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{chain-grad}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaBound{seed}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaComment{--\ Well,\ this\ is\ a\ choice\ I\ suppose}\<%
\\
%
\>[4]\AgdaComment{--δ\ =\ ∇\ seed\ one\ (env-imap\ \{Γ\ =\ Γ\ ▹\ ar\ s\}\ (const\ zero))}\<%
\\
%
\>[4]\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{env-imap}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{const}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{seed}\<%
\\
%
\>[4]\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{po}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{chain-to-env}\AgdaSpace{}%
\AgdaBound{c}\<%
\\
%
\>[4]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaFunction{env-map}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{Γ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{gradc}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{po}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Sac.SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[2]\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}))}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{,,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"∂/∂"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{,,}}\AgdaSpace{}%
\AgdaBound{v}\<%
\\
\>[0]\<%
\\
%
\>[2]\AgdaFunction{filter-grad}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Sac.SEnv}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{filter-grad}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[22]\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sac.env-rev-list}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\>[2]\AgdaFunction{filter-grad}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaFunction{filter-grad}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaBound{δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-grad-sac}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Env′}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{chain-grad-sac}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaBound{vars}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaBound{c}\<%
\\
%
\>[4]\AgdaBound{vals}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sac.env-sac}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaBound{vars}\<%
\\
%
\>[4]\AgdaBound{assignments}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{filter-grad}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{Sac.zip-env}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"∂/∂\%s\ =\ \%s;"}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{vars}\AgdaSpace{}%
\AgdaBound{vals}\<%
\\
%
\>[4]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaFunction{intersperse}\AgdaSpace{}%
\AgdaString{"\textbackslash{}n"}\AgdaSpace{}%
\AgdaBound{assignments}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-sac-l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{chain-sac-l}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\\
%
\>[2]\AgdaFunction{chain-sac-l}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{c}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[3008I]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{n′}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{Sac.to-sac}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{multiopt}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{chain-sac-ctx}\AgdaSpace{}%
\AgdaBound{c}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[.][@{}l@{}]\<[3008I]%
\>[32]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaFunction{printf}\AgdaSpace{}%
\AgdaString{"\%s\ =\ \%s;"}\AgdaSpace{}%
\AgdaBound{v}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaFunction{chain-sac-l}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaBound{n′}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{chain-sac}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{chain-sac}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{intersperse}\AgdaSpace{}%
\AgdaString{"\textbackslash{}n"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{L.reverse}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\$}}\AgdaSpace{}%
\AgdaFunction{chain-sac-l}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaNumber{1}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ test-chain\ :\ Chain\ \AgdaUnderscore{}\ --(ε\ ▹\ ar\ (ι\ 3))}\<%
\\
%
\>[2]\AgdaComment{--\ test-chain\ =\ ε\ \{Γ\ =\ ε\ ▹\ ar\ (ι\ 3)\}\ (\AgdaUnderscore{}\ ,,\ "a")\ }\<%
\\
%
\>[2]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ ▹\ ("r"\ ,\ mul-test)}\<%
\\
%
\>[2]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ ▹\ ("r₁"\ ,\ (var\ v₀)\ ⊠\ (var\ v₂))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaComment{--\ test-grad\ :\ String}\<%
\\
%
\>[2]\AgdaComment{--\ test-grad\ =\ chain-sac\ test-chain\ }\<%
\\
%
\>[2]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ ++\ "\textbackslash{}n"\ ++\ chain-grad-sac\ test-chain\ (chain-grad\ test-chain\ one)}\<%
\end{code}

Let us consider a small example to see this in action.  We start with a little
convenience data structure \AF{ChainCtx} that keeps the shapes and the variable names
together.  We also define the function \AF{ce-split} that splits 
\AF{ChainCtx} into the context and the environment with variable names in that context:
\begin{code}%
%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\<%
\\
%
\>[4]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}▹\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPostulate{String}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaDatatype{S}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaRecord{Σ}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSpace{}%
\AgdaFunction{Sac.SEnv}\<%
\end{code}
\begin{code}[hide]%
%
\>[2]\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[2]\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{cx}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaBound{cx}\AgdaSpace{}%
\AgdaKeyword{in}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Δ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaInductiveConstructor{ar}\AgdaSpace{}%
\AgdaBound{s}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{Product}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Product}\AgdaSpace{}%
\AgdaNumber{0}%
\>[18]\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
%
\>[2]\AgdaFunction{Product}\AgdaSpace{}%
\AgdaNumber{1}%
\>[18]\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[2]\AgdaCatchallClause{\AgdaFunction{Product}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{suc}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{n}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{A}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaFunction{Product}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ℕ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaFunction{Product}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[2]\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaNumber{0}%
\>[23]\AgdaSymbol{\{}\AgdaBound{is}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{⊤}\<%
\\
%
\>[2]\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaNumber{1}%
\>[23]\AgdaSymbol{\{}\AgdaBound{is}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{is}\<%
\\
%
\>[2]\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{is}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSymbol{\}}%
\>[33]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{E}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{×}}\AgdaSpace{}%
\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{p}\AgdaSymbol{\}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{↑↑ₙ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Ctx}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{is}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Product}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaDatatype{IS}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{p}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Es}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{is}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaBound{is}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{p}\AgdaSymbol{\}}\<%
\\
%
\>[2]\AgdaFunction{↑↑ₙ}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSpace{}%
\AgdaBound{es}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{↑↑ₙ}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaBound{e}%
\>[11]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[2]\AgdaFunction{↑↑ₙ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{es}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{e}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{↑↑ₙ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{es}\<%
\end{code}
Consider an initial environment of two 5-element vectors $a$ and $b$; local
computations $x = ab$ and $y = xx$; and the generated code when computing derivative
of $y$ (\AC{var v₀}) on the right.
\begin{mathpar}
\codeblock{\begin{code}%
%
\>[2]\AgdaFunction{test-chain}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{test-chain}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"a"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"b"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{))}\<%
\\
%
\>[4]\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[4]\AgdaBound{C₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}%
\>[18]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"x"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[4]\AgdaBound{C₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₁}%
\>[18]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"y"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊠}}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaBound{C₂}\<%
\end{code}}
\and
{\begin{varwidth}{0.9\textwidth}
\begin{lstlisting}[linewidth=.44\textwidth]
x = (a) * (b);
y = (x) * (x);
ddy = one;
ddx = ((ddy) * (x)) + ((ddy) * (x));
ddb = (ddx) * (a);
dda = (ddx) * (b);
\end{lstlisting}
\end{varwidth}}
\end{mathpar}
Let us convince ourselves that the result is correct.  Our expression is $abab = a^2b^2$,
and its partial derivatives $\frac{\partial}{\partial a} = 2ab^2$,
$\frac{\partial}{\partial b} = 2ba^2$.  If we fold the assignments, we get:
\begin{eqnarray*}
   \text{dda} &= (x + x)b = (ab + ab)b = 2ab^2\\
   \text{ddb} &= (x + x)a = (ab + ab)a = 2ba^2
\end{eqnarray*}
Note that computations in $x$ and \texttt{ddx} are shared in further computations
which was the main goal of introducing this mechanism.

There are two inconveniences in the above implementation that we would like to
mention:
\begin{enumerate}
\item There is no restriction on using the placeholders for derivatives in the 
chain expressions, so in principle, one could write expression in terms of
variables and their derivatives.  However, this is not being handled and likely
to generate bogus terms.  If this is a useful feature, it requires more thinking
on how exactly it should work.  Otherwise it is easy to introduce restrictions
that rule out such cases.
\item If we define variables in the chain that do not contribute to the final
expression, we may introduce extra computations.  We do not compromise correctness,
as all inaccessible terms will get zero value.  However, direct execution of the
resulting expressions may introduce redundant computations.
\end{enumerate}
Both of these are future work.  For now, we make an assumption that placeholders
are not used in the expressions and that we do not insert bindings that do not
contribute to the final result.

\begin{code}[hide]%
%
\>[2]\AgdaFunction{test-chain-sac}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{test-chain-sac}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{=}%
\>[3249I]\AgdaFunction{chain-sac}\AgdaSpace{}%
\AgdaFunction{test-chain}\<%
\\
\>[3249I][@{}l@{\AgdaIndent{0}}]%
\>[13]\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaString{"\textbackslash{}n"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaFunction{chain-grad-sac}\AgdaSpace{}%
\AgdaFunction{test-chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{chain-grad}\AgdaSpace{}%
\AgdaFunction{test-chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{one}\AgdaSymbol{))}\<%
\\
\>[0]\<%
\end{code}

We present the specification of our case study in \AF{E} using \AF{Chain}.  We start
with the context \AF{cnn-ctx} that contains the \texttt{target} digit that
is depicted on the image, the input image \texttt{inp} and the weights of the network.
The definition of the chain is a one-to-one copy of the definition found in
Section~\ref{sec:cnn}.  The only real difference is that we have to take care of
maintaining bindings between Agda variables and the variables in \AF{E}.  Fortunately,
let expressions in Agda make it possible to shadow the binding, which comes very
useful in this case.

{\small
\begin{code}%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[2]\AgdaFunction{cnn-ctx}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChainCtx}\<%
\\
%
\>[2]\AgdaFunction{cnn-ctx}%
\>[11]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"target"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{))))}%
\>[66]\AgdaComment{--\ 7}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"inp"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{28}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{28}\AgdaSymbol{)}%
\>[66]\AgdaComment{--\ 6}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"k₁"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{))}%
\>[66]\AgdaComment{--\ 5}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"b₁"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{6}\AgdaSymbol{)}%
\>[66]\AgdaComment{--\ 4}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"k₂"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{6}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{5}\AgdaSymbol{)))}%
\>[66]\AgdaComment{--\ 3}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"b₂"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSymbol{)}%
\>[66]\AgdaComment{--\ 2}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"fc"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSymbol{))))}%
\>[66]\AgdaComment{--\ 1}\<%
\\
%
\>[11]\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"b"}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaNumber{10}\AgdaSymbol{)}%
\>[66]\AgdaComment{--\ 0}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{cnn-chain}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Chain}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\>[2]\AgdaFunction{cnn-chain}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{ce-split}\AgdaSpace{}%
\AgdaFunction{cnn-ctx}\<%
\\
%
\>[6]\AgdaBound{inp}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₆}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₅}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₄}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₃}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₁}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ε}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Γ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{ρ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"c₁₁"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{inp}\AgdaSpace{}%
\AgdaBound{k₁}\AgdaSpace{}%
\AgdaBound{b₁}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{));}%
\>[71]\AgdaBound{k₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSymbol{;}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{c₁₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₁}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"c₁"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{c₁₁}\AgdaSymbol{);}%
\>[71]\AgdaBound{k₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSymbol{;}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₃}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₂}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"s₁"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{avgp₂}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaNumber{12}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{c₁}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{));}%
\>[71]\AgdaBound{k₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSymbol{;}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{s₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₄}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₃}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"c₂₁"}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{s₁}\AgdaSpace{}%
\AgdaBound{k₂}\AgdaSpace{}%
\AgdaBound{b₂}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{)));}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{c₂₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₅}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₄}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"c₂"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{c₂₁}\AgdaSymbol{);}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₆}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₅}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"s₂"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{i}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Imap}\AgdaSpace{}%
\AgdaSymbol{λ}\AgdaSpace{}%
\AgdaBound{j}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{avgp₂}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaNumber{4}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sel}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{c₂}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaBound{i}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaBound{j}\AgdaSymbol{));}%
\>[96]\AgdaBound{fc}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{s₂}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₇}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₆}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"r₁"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{mconv}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaBound{s₂}\AgdaSpace{}%
\AgdaBound{fc}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{ι}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊗}}\AgdaSpace{}%
\AgdaInductiveConstructor{ι}\AgdaSymbol{))));}%
\>[96]\AgdaBound{r₁}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\<%
\\
%
\>[6]\AgdaBound{C₈}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{C₇}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{▹}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaString{"r"}%
\>[23]\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{logistic}\AgdaSpace{}%
\AgdaBound{r₁}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaBound{C₈}\<%
\end{code}

\begin{code}[hide]%
%
\>[2]\AgdaFunction{test-cnn}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPostulate{String}\<%
\\
%
\>[2]\AgdaFunction{test-cnn}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{=}%
\>[3570I]\AgdaKeyword{let}\<%
\\
\>[3570I][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaComment{--\ 2*8\ +\ 7\ =\ 23}\<%
\\
%
\>[8]\AgdaBound{target}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}%
\>[33]\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑↑}}%
\>[49]\AgdaOperator{\AgdaFunction{↑↑}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{↑}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSymbol{)}\<%
\\
\>[.][@{}l@{}]\<[3570I]%
\>[6]\AgdaKeyword{in}%
\>[3584I]\AgdaFunction{chain-sac}\AgdaSpace{}%
\AgdaFunction{cnn-chain}\<%
\\
\>[3584I][@{}l@{\AgdaIndent{0}}]%
\>[13]\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaString{"\textbackslash{}n"}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaFunction{chain-grad-sac}\AgdaSpace{}%
\AgdaFunction{cnn-chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{chain-grad}\AgdaSpace{}%
\AgdaFunction{cnn-chain}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{v₀}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{⊞}}\AgdaSpace{}%
\AgdaInductiveConstructor{minus}\AgdaSpace{}%
\AgdaBound{target}\AgdaSymbol{))}\<%
\end{code}
}

